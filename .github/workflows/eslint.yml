name: ESLint Review

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: backend
        run: npm install --only=dev

      - name: Run ESLint
        working-directory: backend
        id: eslint
        run: |
          npx eslint . --config .eslintrc.json --format=json -o eslint-results.json || true

      - name: Annotate ESLint Issues
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: backend/eslint-results.json

      - name: Post Review Based on ESLint
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('backend/eslint-results.json', 'utf8'));

            if (results.length > 0) {
              const comments = results.map(issue => {
                return {
                  path: issue.filePath.replace(process.cwd(), ''),
                  line: issue.messages[0].line,
                  body: `ESLint issue: ${issue.messages[0].message} (${issue.messages[0].ruleId})`
                };
              });

              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                comments,
              });
            } else {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'APPROVE',
                body: 'ESLint passed with no issues!',
              });
            }
