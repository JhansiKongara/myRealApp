name: ESLint Review

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: backend
        run: npm install --only=dev

      - name: Run ESLint
        working-directory: backend
        id: eslint
        run: |
          npx eslint . --config .eslintrc.json --format=json -o eslint-results.json || true

      - name: Annotate ESLint Issues
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('backend/eslint-results.json', 'utf8'));

            const comments = results.flatMap(result => 
              result.messages.map(message => ({
                path: result.filePath.replace(process.cwd() + '/', ''),
                line: message.line,
                body: `ESLint issue: ${message.message} (${message.ruleId})`,
              }))
            );

            if (comments.length > 0) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                comments,
              });
            } else {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'APPROVE',
                body: 'ESLint passed with no issues!',
              });
            }
